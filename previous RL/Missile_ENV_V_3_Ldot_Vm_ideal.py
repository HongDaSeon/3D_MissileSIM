#!/usr/bin/env python
#-*- coding: utf-8 -*-
################################################################################################################################################################################ -ohh`  #####################                
#                                                                                                                                                                             -ohNMMMMd`                    #
#                                                                                                                                                                         -ohNMMMMMmMMMd`                   #
#                                                                                                                                                                     -ohNMMMMNho-  yMMMd`                  #
#                                                                                                                                                                 -ohNMMMMNho-       yMMMd`                 #
#                                                                                                                                                             -ohNMMMMNho-            yMMMd`                #
#                                                                                                                                                         -+hNMMMMMdo-                 yMMMd`               #
#                                                                                                                                                     -+hNMMMMMdo:`                     yMMMd`              #
#                                                                                                                                                 -+hNMMMMMho-                           sMMMd`             #
#                                                                                                                                                `dMMMMho-                                sMMMd`            #
#                                                                                                                                                 `dMMMo                                   sMMMd`           #
#                                                                                                                                                  `dMMMs                                   sMMMd`          #
#                                                                                                                                                   `dMMMs                                   sMMMm`         #
#                                                                                                                                                    `dMMMo         `:osyyo/.                 sMMMm`        #
#                                                                                                                                                     `dMMMo      `sNMMMMMMMMh-                sMMMm`       #
#    MMMMMMMMo mMMMMNNds-    -yNMMMMNd-      sMMs                -MMh                                    `ddh                                          `dMMMo    `mMMMMMMMMMMMM/                sMMMm`      #
#    MMM/----. mMMo--+mMMy  oMMN+.`./h:      sMMy      -+osso/.  -MMh-+so:    :osso/`  .++:`/+`-+osso/. `+MMN++/  -+sso/.  `++/`:+/++-   :++.           `dMMMo   oMMMMMMMMMMMMMm                 sMMMm.     #
#    MMMyssss` mMM/   `mMM/.MMM-             sMMy      oysosmMM/ -MMNhydMMy -mMNsodMN/ /MMNMNN.oysosmMM/.yMMMyyo`dMMyohMMo .MMNNNN+NMN. -MMd             `dMMMs  oMMMMMMMMMMMMMm              ./ymMMMMm`    #
#    MMMhyyyy` mMM/    dMMo-MMM`             sMMy      .+syhmMMs -MMh   NMM.hMM/  `MMM`/MMh    .+syhmMMs `MMN   sMMo   mMM-.MMm`   :MMh dMN.              `dMMMs `mMMMMMMMMMMMM:          `/ymMMMMMms/`     #
#    MMM.      mMM/  `oMMm` mMMy`    /.      sMMy     :MMd:-oMMs -MMh  `NMM`hMM/  `MMN`/MMy   :MMd:-oMMs `MMN   oMMs   mMM-.MMm     oMMdMM:                `dMMMs `sNMMMMMMMMh-       `/smMMMMMms/`         #
#    MMM.      mMMmdmMMNs`  `yMMNdhdNM:      sMMNmmmmd-MMNssmMMs -MMNyyNMN/ .mMNysmMN/ /MMy   -MMNssmMMs  mMMhss`hMMysdMMo .MMm      hMMMs                  `dMMMs   -+ssso/`     `/smMMMMMms/`             #
#    ///`      //////:.       `:+oo+:.       -//////// .+o+:.//- `//::++/`    -+oo+:`  .//-    .+o+:.//-   :+o+:  ./ooo/`  `///      +MMd                    `dMMMs           ./smMMMMMms/`                 #
#                                                                                                                                   .NMN.                     `dMMMs      ./ymMMMMMms/`                     #
#                                                                                                                                   `..`                       `hMMMs `/smMMMMMmy/`                         #
#                                                                                                                                                               `hMMMmMMMMMmy/.                             #
#                                             T  H  E    M  O  T  I  O  N    T  E  C  H  N  O  L  O  G  Y    I  N  N  O  V  A  T  I  O  N  S                     `hMMMMmy/.                                 #
#                                                                                                                                                                 `yy/.                                     #
#                                                                                                                                                                                                           #
#   ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  #
#                                                                                                                                                                                                           #
#                    `++++++/-`    `+++++++-   -+ooo+:  .++.     ./oooo+-   +++`     :+/   +++++++-  -++++++++++++//:.                                                                                      #
#                    .MMmyyhmMMh-  `MMmyyyy: -mMmsosyy  /MM:   +mMmyssydh   MMMN:    hMm   NMmyyyy/  oMMMMMMMMMMMMMMMMMmy+.                                                                                 #
#                    .MMo    -mMN. `MMo      sMM/       /MM:  hMN/          MMhNMo   hMm   NMy       oMMMMMMMMMMMMMMMMMMMMMh:                                                                               #
#                    .MMo     :MMo `MMmyyyy` `yMMmy+.   /MM: :MMo  `+++++.  MMs.dMh` hMm   NMmyyyy.  oMMMMM+     `.:odMMMMMMMy                                                                              #
#                    .MMo     /MM+ `MMh++++`   `:sdMMy  /MM: :MMo  `yydMM:  MMs  sMm-hMm   NMd++++`  oMMMMM+          .yMMMMMMy                                                                             #
#                    .MMo   `+NMh  `MMo      .     sMM: /MM:  dMN/    /MM:  MMs   /NMmMm   NMy       oMMMMM+            +MMMMMM:                                                                            #
#                    .MMNddmMMh/   `MMNdddds sNdyydMMy  /MM:  `omMNdhhNMM-  MMs    .dMMm   NMNddddy  oMMMMM+             hMMMMMy                                                                            #
#                     :::::-.       :::::::- `-////-`   `::`     .:///:-`   ::.      ::-   :::::::-  oMMMMM+             +MMMMMm                                                                            #
#                                                                                                    oMMMMM+             +MMMMMd                                                                            #
#                                                                                .-`                 oMMMMM+             hMMMMMs                                                                            #
#                                                                                dM:                 oMMMMM+            /MMMMMM. `mmm.    /hmmmm+ `mmmmmm`  /hmNNmy:   dmd.   -mh                           #
#                                                                                dM:-//- `//`  `/:   oMMMMM+          `oMMMMMM/  hMoMd   -MM.   ` `MM`    `dMs.  -hMy  mMmN/  :Md                           #
#                                                                                dMdo+hMy sMs  yM/   oMMMMM+       `:sNMMMMMm:  oMs yMo   sNNh+.  `MMysso +Mm     .MM. mM-sMs :Md                           #
#                                                                                dM:  `MM` dM::Ms    oMMMMMmhhhhddNMMMMMMMNo`  :MMssyMM:    -omMy `MM:::- /MN`    -MM` mM- :Nd/Md                           #
#                                                                                dMy..sMd  `mmNd     oMMMMMMMMMMMMMMMMMmy:    `NM+:::+MN`-+-.-sMm `MM/:::` yMd+::oNN/  mM-  .dMMd                           #
#                                                                                os/shy/    :MN.     /hhhhhhhhhhhyso+:`       /s+     +s/.syhys+` `ssssss-  .+yhys/`   os.    oso                           #
#                                                                                         /+mN-                                                                                                             #
######################################################################################## /+:` ###############################################################################################################

# Missile_Environment for Reinforcement Learning
#    v-1.6
#       LPF available
#       Normalize all state

import vpython as vp

import math as m
import numpy as np
import torch
import torchvision
import torch.nn as nn
import torchvision.transforms as transforms
import time
import copy

#Missile coordinate trans Model
class Missile_2D:
    
    def __init__(self, scavel, initpos_x, initpos_y, initpsi, dt):
        self.initval        = [scavel, initpos_x, initpos_y, initpsi]
        self.scavel         = scavel
        self.pos_x          = initpos_x
        self.pos_y          = initpos_y
        self.psi            = initpsi
        self.ay_m           = 0.
        self.dt             = dt
        self.dx             = self.scavel * m.cos(self.psi)
        self.dy             = self.scavel * m.sin(self.psi)
        self.vizpos         = vp.vec(self.pos_x, self.pos_y, 0.)
        self.vizvel         = vp.vec(self.dx, self.dy, 0.)
        self.C_nb           = np.array([[m.cos(-1.5707), -m.cos(-1.5707), 0],
                                        [m.sin(-1.5707),  m.cos(-1.5707), 0],
                                        [0, 0, 1]])
        self.accbuf         = (np.matmul(self.C_nb, np.array([self.dx, self.dy, 0.])).tolist())
        self.accaxi         = vp.vec(self.accbuf[0],self.accbuf[1],self.accbuf[2])
        self.d_psi_m        = 0
        self.reset_flag     = True

    def simulate(self, ay_m):
        self.ay_m           = ay_m
        self.d_psi_m        = self.ay_m[0] / self.scavel
        self.psi            = self.psi + self.d_psi_m * self.dt
        self.dx             = self.scavel * m.cos(self.psi)
        self.dy             = self.scavel * m.sin(self.psi)
        self.pos_x          = self.pos_x + self.dx*self.dt
        self.pos_y          = self.pos_y + self.dy*self.dt
        self.C_nb           = np.array([[m.cos(self.psi), -m.sin(self.psi), 0],
                                        [m.sin(self.psi),  m.cos(self.psi), 0],
                                        [0, 0, 1]])
        self.vizpos         = vp.vec(self.pos_x, self.pos_y, 0.)
        self.vizvel         = vp.vec(self.dx, self.dy, 0.)
        self.accbuf         = (np.matmul(self.C_nb, np.array([self.dx, self.dy, 0.])).tolist())
        self.accaxi         = vp.vec(self.accbuf[0],self.accbuf[1],self.accbuf[2])
        #print(self.psi)
        return self.dx, self.dy, self.pos_x, self.pos_y

    def reset(self, xpos, ypos, hed, Vm, reset_flag):
        self.scavel         = Vm
        self.pos_x          = xpos
        self.pos_y          = ypos
        self.psi            = hed
        self.ay_m           = 0.
        self.dt             = self.dt
        self.dx             = self.scavel * m.cos(self.psi)
        self.dy             = self.scavel * m.sin(self.psi)
        self.vizpos         = vp.vec(self.pos_x, self.pos_y, 0.)
        self.vizvel         = vp.vec(self.dx, self.dy, 0.)
        self.C_nb           = np.array([[m.cos(self.psi), -m.sin(self.psi), 0],
                                        [m.sin(self.psi),  m.cos(self.psi), 0],
                                        [0, 0, 1]])
        self.accbuf         = (np.matmul(self.C_nb, np.array([self.dx, self.dy, 0.])).tolist())
        self.accaxi         = vp.vec(self.accbuf[0],self.accbuf[1],self.accbuf[2])
        self.reset_flag     = reset_flag
    
    def __str__(self):
        nowpos = 'x : '+str(self.pos_x)+' y : '+str(self.pos_y)

        return nowpos

#Target Model
class TargetShip:
    
    def __init__(self, initpos_x, initpos_y, vel_x, vel_y):
        self.pos_x          = initpos_x
        self.pos_y          = initpos_y
        self.dx         = vel_x
        self.dy         = vel_y
        self.vizpos         = vp.vec(self.pos_x, self.pos_y, 0.)
        self.vizvel         = vp.vec(self.dx, self.dy, 0.)
    
    def __str__(self):
        nowpos = 'x : '+str(self.pos_x)+' y : '+str(self.pos_y)

        return nowpos

#Seeker Model
class Seeker:
    #prevR = 0
    def __init__(self, Missile, Target):
        self.Rvec       = np.array([Target.pos_x - Missile.pos_x, Target.pos_y - Missile.pos_y], dtype = np.float64)
        self.Vvec       = np.array([Target.dx - Missile.dx, Target.dy - Missile.dy], dtype = np.float64)
        self.direcVec   = np.array([Missile.dx, Missile.dy], dtype = np.float64)
        self.Target     = Target
        self.Missile    = Missile
        self.R          = self.getmag(self.Rvec)
        self.impactR    = 50000
        self.LOS        = self.angle(self.direcVec,self.Rvec)
        self.initLOS    = self.angle(self.direcVec,self.Rvec)
        self.Ldot       = 0.0
        self.fLdot      = 0.0
        self.fLOS       = self.LOS
        self.firstrun   = True
        self.filter1st  = True
        self.CLdot      = 0.
        self.RLdot      = 0.
        self.prev_Rvec  = [35000,35000]
        self.t2go       = 600
        self.Vmiss      = Missile.scavel
        
    def angle(self, vec1, vec2):
        dot = vec1[0]*vec2[0] + vec1[1]*vec2[1]      # dot product
        det = vec1[0]*vec2[1] - vec2[0]*vec1[1]      # determinant
        return m.atan2(det, dot)  # atan2(y, x) or atan2(sin, cos)

    def getmag(self,vec):
        mag             = np.sqrt(sum(vec**2))

        return mag

    def seek(self):
        def normR(Rval):
            return (Rval-40000)/10000

        def normL(LOSval):
            return (LOSval/1.57)

        def normLd(LOSdotval):
            return (LOSdotval)*1000

        def normtg(t2goval):
            return (t2goval)/350

        def normVm(Vval):
            return (Vval-400)/200

        self.t2go       = 0
        self.Rvec       = np.array([self.Target.pos_x - self.Missile.pos_x, self.Target.pos_y - self.Missile.pos_y], dtype = np.float64)
        self.Vvec       = np.array([self.Target.dx - self.Missile.dx, self.Target.dy - self.Missile.dy], dtype = np.float64)
        self.direcVec   = np.array([self.Missile.dx, self.Missile.dy], dtype = np.float64)
        #print(self.Vvec)
        self.R          = self.getmag(self.Rvec)
        
        self.LOS        = self.angle(self.direcVec,self.Rvec)
        if self.Missile.reset_flag == True:
            self.initLOS = self.LOS
            #print(self.initLOS)

        if self.filter1st:
            self.prevfL = self.LOS
            self.filter1st = False
            self.fLOS = self.LOS
        else:
            alpha = 0.9
            self.fLOS = alpha*self.prevfL + (1-alpha)*self.LOS

        dlam_m = self.Missile.scavel/self.R * m.sin(self.LOS)
        
        RjxVj = np.cross([self.Rvec[0],self.Rvec[1],0], [self.Vvec[0],self.Vvec[1],0])
        RjdRj = np.dot([self.Rvec[0],self.Rvec[1],0],[self.Rvec[0],self.Rvec[1],0])
        Ldotn = RjxVj/RjdRj
        self.Vmiss = self.Missile.scavel
        Ldotb = (np.matmul(self.Missile.C_nb.T, Ldotn))[2]
        self.RLdot = Ldotb
        self.Missile.reset_flag = False
        return self.R, self.LOS, self.RLdot, self.fLOS, self.Vmiss, np.array([normLd(self.RLdot), normVm(self.Missile.scavel)])

    def spit_reward(self, acc):
        if self.firstrun == True:
            self.prevR      = self.R
            self.prevL      = self.LOS
            self.prevfL     = self.fLOS
            self.Rdot       = self.Missile.scavel
            self.Ldot       = 0.0
            self.fLdot      = 0.0
            self.firstrun   = False
            #print(prevR)
            #print(self.firstrun)
        elif self.firstrun == False:
            self.Rdot       = (self.R - self.prevR)/self.Missile.dt
            self.Ldot       = (self.LOS - self.prevL)/self.Missile.dt
            self.fLdot      = (self.fLOS - self.prevfL)/self.Missile.dt
            self.prevR      = self.R
            self.prevL      = copy.deepcopy(self.LOS)
            self.prevfL     = copy.deepcopy(self.fLOS)
            #print(Rdot)
            if (self.Rdot>200):
                self.Rdot = 0
            if (abs(self.Ldot)>=3.15):
                self.Ldot = 0
            if (abs(self.fLdot)>=3.15):
                self.fLdot = 0
        #print(Ldot, self.LOS)

        
        #print(self.LOS)
        
        OOR         = (self.LOS < -1.57)|(self.LOS > 1.57) # Out of range
        if OOR:
            R1 = self.prev_Rvec
            R2 = self.Rvec
            R3 = R1 - R2
            disangle = abs(self.angle(R1,R3))
            self.impactR = self.getmag(self.prev_Rvec)*m.sin(disangle)
            #print(self.impactR)
        else:
            self.prev_Rvec   = self.Rvec


        hit         = (self.impactR <5)

        step_reward  = - (acc[0]**2)
         #0.01*-Rdot - 3*abs(self.LOS) - 1.2*abs(self.LOS)*500*abs(Ldot) + (2/(self.R / 8000))**2.5 - (self.R<10000)*self.R/5000 #-1000*abs(Ldot)   -self.R/10000  # - self.R/100
        
        mc_reward    =  - (self.impactR)
        #reward = (not OOR)*reward -OOR*25
        #print(str(-m.sqrt(self.R)/100)+'   '+str(acc[0]**2))
        #print( -(self.R / 50000)**2, - ((self.Ldot**2)*7e+2))
        #print(Rdot)
        return step_reward, mc_reward, (hit|OOR), hit

